p8105\_hw6\_bs3142
================
Bingyu Sun
11/19/2018

Problem 1
---------

### Data Import & Cleaning

-   **Create a city\_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. Modifiy victim\_race to have categories white and non-white, with white as the reference category. Be sure that victim\_age is numeric.**

``` r
homicides_data =
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  na.omit() %>%
  mutate(city_state = str_c(city, state, sep = ", ")) %>%
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  mutate(
    resolved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age),
    victim_race = ifelse(victim_race == "White", "white", "non-white"),
    victim_race = fct_relevel(victim_race, "white")
  )
## Parsed with column specification:
## cols(
##   uid = col_character(),
##   reported_date = col_integer(),
##   victim_last = col_character(),
##   victim_first = col_character(),
##   victim_race = col_character(),
##   victim_age = col_integer(),
##   victim_sex = col_character(),
##   city = col_character(),
##   state = col_character(),
##   lat = col_double(),
##   lon = col_double(),
##   disposition = col_character()
## )
```

### Q & A

**1. For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object.**

``` r
fit_logistic_baltimore =
  homicides_data %>%
  filter(city_state == "Baltimore, MD") %>%
  select(resolved, victim_age, victim_sex, victim_race) %>%
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

fit_logistic_baltimore %>%
  broom::tidy()
## # A tibble: 4 x 5
##   term                 estimate std.error statistic  p.value
##   <chr>                   <dbl>     <dbl>     <dbl>    <dbl>
## 1 (Intercept)           1.19      0.235        5.06 4.30e- 7
## 2 victim_age           -0.00699   0.00326     -2.14 3.22e- 2
## 3 victim_sexMale       -0.888     0.136       -6.53 6.80e-11
## 4 victim_racenon-white -0.820     0.175       -4.69 2.68e- 6
```

**2. Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.**

``` r
fit_logistic_baltimore %>%
  broom::tidy(conf.int = TRUE) %>%
  mutate(OR = exp(estimate)) %>%
  select(term, OR, log_OR = estimate, starts_with("conf")) %>%
  filter(term == "victim_racenon-white")
## # A tibble: 1 x 5
##   term                    OR log_OR conf.low conf.high
##   <chr>                <dbl>  <dbl>    <dbl>     <dbl>
## 1 victim_racenon-white 0.441 -0.820    -1.16    -0.479
```

**3. Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.**

``` r
tidy = function(df) {
  broom::tidy(df, conf.int = TRUE)
}

homicides_statistics =
  homicides_data %>%
  group_by(city_state) %>%
  nest() %>% 
  mutate(
    fit_model = map(.x = data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    fit_model = map(fit_model, tidy)
    ) %>%
  select(-data) %>%
  unnest() %>%
  mutate(OR = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high)) %>%
  select(city_state, term, OR, starts_with("conf")) %>%
  filter(term == "victim_racenon-white")
```

**4. Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.**

``` r
homicides_statistics %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

<img src="p8105_hw6_bs3142_files/figure-markdown_github/unnamed-chunk-5-1.png" width="90%" />

**Comment:**

Problem 2
---------

### Data Import & Cleaning

-   **Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).**

``` r
birthweight_data =
  read_csv("./data/birthweight.csv", col_types = "dddddddddddddddddddd") %>%
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace))

str(birthweight_data)
## Classes 'tbl_df', 'tbl' and 'data.frame':    4342 obs. of  20 variables:
##  $ babysex : Factor w/ 2 levels "1","2": 2 1 2 1 2 1 2 2 1 1 ...
##  $ bhead   : num  34 34 36 34 34 33 33 33 36 33 ...
##  $ blength : num  51 48 50 52 52 52 46 49 52 50 ...
##  $ bwt     : num  3629 3062 3345 3062 3374 ...
##  $ delwt   : num  177 156 148 157 156 129 126 140 146 169 ...
##  $ fincome : num  35 65 85 55 5 55 96 5 85 75 ...
##  $ frace   : Factor w/ 5 levels "1","2","3","4",..: 1 2 1 1 1 1 2 1 1 2 ...
##  $ gaweeks : num  39.9 25.9 39.9 40 41.6 ...
##  $ malform : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
##  $ menarche: num  13 14 12 14 13 12 14 12 11 12 ...
##  $ mheight : num  63 65 64 64 66 66 72 62 61 64 ...
##  $ momage  : num  36 25 29 18 20 23 29 19 13 19 ...
##  $ mrace   : Factor w/ 4 levels "1","2","3","4": 1 2 1 1 1 1 2 1 1 2 ...
##  $ parity  : num  3 0 0 0 0 0 0 0 0 0 ...
##  $ pnumlbw : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ pnumsga : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ ppbmi   : num  26.3 21.3 23.6 21.8 21 ...
##  $ ppwt    : num  148 128 137 127 130 115 105 119 105 145 ...
##  $ smoken  : num  0 0 1 10 1 0 0 0 0 4 ...
##  $ wtgain  : num  29 28 11 30 26 14 21 21 41 24 ...
skimr::skim(birthweight_data)
## Skim summary statistics
##  n obs: 4342 
##  n variables: 20 
## 
## ── Variable type:factor ────────────────────────────────────────────────────────────
##  variable missing complete    n n_unique                      top_counts
##   babysex       0     4342 4342        2         1: 2230, 2: 2112, NA: 0
##     frace       0     4342 4342        5 1: 2123, 2: 1911, 4: 248, 3: 46
##   malform       0     4342 4342        2           0: 4327, 1: 15, NA: 0
##     mrace       0     4342 4342        4 1: 2147, 2: 1909, 4: 243, 3: 43
##  ordered
##    FALSE
##    FALSE
##    FALSE
##    FALSE
## 
## ── Variable type:numeric ───────────────────────────────────────────────────────────
##  variable missing complete    n      mean     sd     p0     p25     p50
##     bhead       0     4342 4342   33.65     1.62  21      33      34   
##   blength       0     4342 4342   49.75     2.72  20      48      50   
##       bwt       0     4342 4342 3114.4    512.15 595    2807    3132.5 
##     delwt       0     4342 4342  145.57    22.21  86     131     143   
##   fincome       0     4342 4342   44.11    25.98   0      25      35   
##   gaweeks       0     4342 4342   39.43     3.15  17.7    38.3    39.9 
##  menarche       0     4342 4342   12.51     1.48   0      12      12   
##   mheight       0     4342 4342   63.49     2.66  48      62      63   
##    momage       0     4342 4342   20.3      3.88  12      18      20   
##    parity       0     4342 4342    0.0023   0.1    0       0       0   
##   pnumlbw       0     4342 4342    0        0      0       0       0   
##   pnumsga       0     4342 4342    0        0      0       0       0   
##     ppbmi       0     4342 4342   21.57     3.18  13.07   19.53   21.03
##      ppwt       0     4342 4342  123.49    20.16  70     110     120   
##    smoken       0     4342 4342    4.15     7.41   0       0       0   
##    wtgain       0     4342 4342   22.08    10.94 -46      15      22   
##      p75   p100     hist
##    35      41   ▁▁▁▁▅▇▁▁
##    51      63   ▁▁▁▁▁▇▁▁
##  3459    4791   ▁▁▁▃▇▇▂▁
##   157     334   ▁▇▅▁▁▁▁▁
##    65      96   ▁▂▇▂▂▂▁▃
##    41.1    51.3 ▁▁▁▁▃▇▁▁
##    13      19   ▁▁▁▁▂▇▁▁
##    65      77   ▁▁▁▅▇▂▁▁
##    22      44   ▂▇▅▂▁▁▁▁
##     0       6   ▇▁▁▁▁▁▁▁
##     0       0   ▁▁▁▇▁▁▁▁
##     0       0   ▁▁▁▇▁▁▁▁
##    22.91   46.1 ▁▇▅▁▁▁▁▁
##   134     287   ▁▇▆▁▁▁▁▁
##     5      60   ▇▁▁▁▁▁▁▁
##    28      89   ▁▁▁▇▇▁▁▁
```

**Comment:** There is no missing value in the dataset.

### Q & A

**1. Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add\_predictions and add\_residuals in making this plot.**
