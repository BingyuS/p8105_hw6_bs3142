---
title: "p8105_hw6_bs3142"
author: "Bingyu Sun"
date: "11/19/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)
library(modelr)
library(mgcv)
library(leaps)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Problem 1

### Data Import & Cleaning

* **Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. Modifiy victim_race to have categories white and non-white, with white as the reference category. Be sure that victim_age is numeric.**

```{r}
homicides_data =
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  na.omit() %>%
  mutate(city_state = str_c(city, state, sep = ", ")) %>%
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  mutate(
    resolved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age),
    victim_race = ifelse(victim_race == "White", "white", "non-white"),
    victim_race = fct_relevel(victim_race, "white")
  )
```

### Q & A

**1. For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object.**

```{r}
fit_logistic_baltimore =
  homicides_data %>%
  filter(city_state == "Baltimore, MD") %>%
  select(resolved, victim_age, victim_sex, victim_race) %>%
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

fit_logistic_baltimore %>%
  broom::tidy()
```

**2. Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.**

```{r}
fit_logistic_baltimore %>%
  broom::tidy(conf.int = TRUE) %>%
  mutate(OR = exp(estimate)) %>%
  select(term, OR, log_OR = estimate, starts_with("conf")) %>%
  filter(term == "victim_racenon-white")
```

**3. Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.**

```{r}
tidy = function(df) {
  broom::tidy(df, conf.int = TRUE)
}

homicides_statistics =
  homicides_data %>%
  group_by(city_state) %>%
  nest() %>% 
  mutate(
    fit_model = map(.x = data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    fit_model = map(fit_model, tidy)
    ) %>%
  select(-data) %>%
  unnest() %>%
  mutate(OR = exp(estimate),
         conf.low = exp(conf.low),
         conf.high = exp(conf.high)) %>%
  select(city_state, term, OR, starts_with("conf")) %>%
  filter(term == "victim_racenon-white")
```

**4. Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.**

```{r}
homicides_statistics %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

**Comment:**

## Problem 2

### Data Import & Cleaning

* **Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).**

```{r}
birthweight_data =
  read_csv("./data/birthweight.csv", col_types = "dddddddddddddddddddd") %>%
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace))

str(birthweight_data)
skimr::skim(birthweight_data)
```

**Comment:**
There is no missing value in the dataset.

### Q & A

**1. Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.**

**Look at the data:**

```{r}
birthweight_data %>%
  select(-babysex, -frace, -malform, -mrace, -pnumlbw, -pnumsga) %>%
  cor()
```

* Baby's head circumference at birth (bhead), baby's length at birth (blength), and baby's birth weight (bwt) are highly correlated (>0.7).

* Mother's pre-pregnancy BMI (ppbmi), mother's pre-pregnancy weight (ppwt), and mother's weight at delivery (delwt) are highly correlated (>0.7).

```{r}
birthweight_clean =
  birthweight_data %>%
  select(-blength, -ppbmi, -ppwt, -pnumlbw, -pnumsga) %>%
  select(bwt, everything())
```

**Look at outcome distribution**

```{r}
birthweight_clean %>%
  select(bwt) %>%
  ggplot(aes(y = bwt)) + geom_boxplot()

birthweight_clean %>%
  select(bwt) %>%
  ggplot(aes(x = bwt)) + geom_histogram()
```

**Use stepwise approach to get some models**

```{r}
fit_all = lm(bwt ~ ., data = birthweight_clean)

step(fit_all, direction = 'backward')
```

The stepwise approach suggests babysex, bhead, delwt, gaweeks, menarche, mheight, mrace, parity, smoken, and wtgain.

**Check Cp**

```{r}
covariates_fit = data.frame(birthweight_clean)

#leaps(x = covariates_fit[,2:14], y = covariates_fit[,1], nbest=1, method="Cp") 
```

**Model**

```{r}
best_fit_brithweight = lm(bwt~babysex + delwt + gaweeks + mrace + parity + smoken + mheight + wtgain + bhead + menarche, data = birthweight_clean)

birthweight_clean %>% 
  modelr::add_residuals(best_fit_brithweight) %>%
  modelr::add_predictions(best_fit_brithweight) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.25)
```

